<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MovingIndex</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- Roboto -->
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,500,700">

    <link rel="stylesheet" href="css/ratchet.min.css">
    <link rel="stylesheet" href="css/ratchet-theme-android.min.css">
    <link rel="stylesheet" href="css/app.css">


    <script src="js/ratchet.min.js"></script>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>

</head>
<body>
<header class="bar bar-nav">
    <a class="icon icon-compose pull-right" href="new.html"></a>
    <h1 class="title">
        <span class="icon icon-movingindex"></span>
        MovingIndex
    </h1>
</header>

<div class="content">

    <ul class="table-view" id="list_of_events">
        <li class="table-view-cell media" id="scan_option">
            <a class="navigate-right"  onclick="scanCode();" data-ignore="push">
                <span class="media-object pull-left icon icon-code"></span>
                <div class="media-body">
                    Scan QR code
                </div>
            </a>
        </li>
        <li class="table-view-cell media" id="settings_option">
            <a class="navigate-right" href="#settingsModal">
                <span class="media-object pull-left icon icon-gear"></span>
                <div class="media-body">
                    Settings
                </div>
            </a>
        </li>
    </ul>
</div>

<!-- Compose modal -->
<div id="settingsModal" class="modal">
    <header class="bar bar-nav">
        <a class="icon icon-left pull-left" href="#settingsModal"></a>
        <h1 class="title">MovingIndex Settings</h1>
    </header>

    <div class="content">
        <form class="content-padded">
            <h5>API Key</h5>
            <p>Required to use the MovingIndex App</p>
            <input type="text" placeholder="API Key" id="settings_apikey">
            <a class="btn btn-positive btn-block" id="savesettings" href="#settingsModal">Save settings</a>
        </form>
    </div>
</div><!-- /.modal -->

<!-- Compose modal -->
<div id="scanResultsModal" class="modal">
    <header class="bar bar-nav">
        <a class="icon icon-left pull-left" href="#scanResultsModal"></a>
        <h1 class="title">MovingIndex Svcan Results</h1>
    </header>

    <div class="content">
        <form class="content-padded">
            <div id="qresults"></div>
        </form>
    </div>
</div><!-- /.modal -->

<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript">
    app.initialize();

    $.ajaxSetup({
        headers: { 'Authorization': 'Token 51e67391c3520a20f73d5e12201691cb67275ae7' }
    });

    $.ajax({
        url: 'http://192.168.2.5:8000/api/events/',
        success: function(response) {

            jQuery.each(response, function()
            {
                $('#list_of_events').prepend('<li class="table-view-cell">' +
                '<a class="navigate-right"><span class="media-object pull-left icon icon-pages"></span><span class="badge">' + this.pk + '</span>' +
                this.name + '</a></li>');
            });
        },
        error: function(xhr, type) {
            $('#list_of_events').prepend('<li class="table-view-cell">' +
            '<a class="navigate-right"><span class="badge">' + type + '</span>' +
            'Could not retrieve list of Events</a></li>');
        }
    });

    var scanSuccess = function(result) {
        var textFormats = "QR_CODE DATA_MATRIX";
        var productFormats = "UPC_E UPC_A EAN_8 EAN_13";

        if (result.cancelled) {
            return;
        }
        //alert("Scanned Code: " + result.text + ". Format: " + result.format);

        $('#qresults').html("Scanned Code: " + result.text + ". Format: " + result.format);
        $('#scanResultsModal').addClass('active');

        if (textFormats.match(result.format)) {
            var scanVal = result.text;
            if (scanVal.indexOf("http") === 0) {
                navigator.notification.confirm(
                        '(1) Open in Browser\n(2) Cancel',
                        function (b) {
                            if (b === 1) {
                                window.plugins.childBrowser.openExternal(scanVal);
                            }
                        },
                        result.text,
                        '1, 2'
                );
            } else {
                navigator.notification.alert(
                        result.text,
                        function (){},
                        'Scan Value:',
                        'Done'
                );
            }
        } else if (productFormats.match(result.format)) {
            //alert("Found Product Code: " + result.text  + ". Format: " + result.format);
            navigator.notification.confirm(
                    '(1) Look Up Product\n(2) Cancel',
                    function (b) {
                        if (b === 1) {
                            // This is an example url with query - substitute your own here
                            var searchUrl = "http://example.com/urserver/search.pl?q=" + result.text;
                            window.plugins.childBrowser.showWebPage(searchUrl);
                        }
                    },
                    result.text,
                    '1, 2'
            );
        } else {
            alert("Scan format : " + result.format +
            " not supported. Scan value: " + result.text);
        }
    };

    var scanCode = function() {
        cordova.plugins.barcodeScanner.scan(
                scanSuccess,
                function(error) {
                    alert("Scan failed: " + error);
                });
    };
</script>

</body>
</html>
